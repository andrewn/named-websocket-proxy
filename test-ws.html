<!DOCTYPE html>
<html>
<head>
  <title>Test Web Socket</title>
  <style type="text/css">
    body {
      font-family: sans-serif;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <pre id="log"></pre>
  <script type="text/javascript" src="./ui/shim.js"></script>
  <script>
    function log(msg) {
      console.log(arguments);
      document.querySelector('#log').innerHTML += (new Date()) + ': ' + msg + '\n';
    }

    var channel = new NetworkWebSocket('bbc.nws.test');

    channel.onopen = function (evt) {
      log('Connected', evt);
    }

    channel.onmessage = function(evt) {
      log("Broadcast message: " + evt.data, evt);
    };

    // Stop
    channel.onclose = function(evt) {
      log("Connection terminated");
    };

    channel.onconnect = function(evt) {
      var peer;
      window.peer = peer = evt.detail.target;
      log("Peer connected: " + peer.id, evt);
      attachWebSocketLifecycleEventsAndSayHello(peer);
    };

    channel.ondisconnect = function(evt) {
      log("Peer disconnected", evt);
    };

    log('Started');

    function attachWebSocketLifecycleEventsAndSayHello(peer) {
      peer.onmessage = function (evt) {
        log("Direct message from peer: " + evt.data, evt);
      }
      peer.onopen = function (evt) {
        log("Peer connection complete", evt);
        log("Send hello direct to peer: " + peer.id);
        peer.send('Hello');
      }
      peer.onclose = function (evt) {
        log("Peer disconnected", peer.id);
      }
      peer.onerror = function (evt) {
        log("Peer error", peer.id);
      }
    }
  </script>
</body>
</html>